# version: 2.1

# # Define your workflows, jobs, and steps here
# jobs:
#   build:
#     docker:
#       - image: circleci/python:3.9  # Replace with an appropriate Docker image for your project

#     steps:
#       - checkout  # Checkout your project code from version control

#       # Install AWS CLI (if needed)
#       - run:
#           name: Install AWS CLI
#           command: |
#             curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
#             unzip awscliv2.zip
#             sudo ./aws/install

#       # Configure AWS credentials
#       - run:
#           name: Configure AWS credentials
#           command: |
#             # Replace <your_access_key_id> and <your_secret_access_key> with environment variables
#             aws configure set aws_access_key_id $Access_Key
#             aws configure set aws_secret_access_key $Secret_Access_Key
#             aws configure set default.region us-west-1  # Replace with your desired region

#       - run:
#           name: Install Terraform
#           command: |
#             curl "https://releases.hashicorp.com/terraform/1.0.0/terraform_1.0.0_linux_amd64.zip" -o "terraform.zip"
#             unzip terraform.zip
#             sudo mv terraform /usr/local/bin/
#       - run:
#           name: Terraform init
#           command: |
#             terraform init
#             terraform fmt
#             terraform validate
#       - run:
#           name: Terraform Plan
#           command: |
#             terraform plan

#   deploy:
#     steps:
#       - checkout
#       - run:
#           name: Terraform Apply
#           command: |
#             terraform apply -auto-approve

# workflow:
#   version: 2
#   test_build_deploy:
#     - build:
#           filters:
#             branches:
#               only:
#                 - feature

# version: 2.1
# orbs:
#   terraform: circleci/terraform@1.1.0

# # Define your jobs her
# jobs:
#   build:
#     docker:
#       - image: circleci/python:3.9
#       - image: hashicorp/terraform:1.0.0
#     steps:
#       - checkout
#       - run:
#           name: Install AWS CLI
#           command: |
#             curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
#             unzip awscliv2.zip
#             sudo ./aws/install
      
#       # Configure AWS credentials
#       - run:
#           name: Configure AWS credentials
#           command: |
#             # Replace <your_access_key_id> and <your_secret_access_key> with environment variables
#             aws configure set aws_access_key_id $Access_Key
#             aws configure set aws_secret_access_key $Secret_Access_Key
#             aws configure set default.region us-west-1  # Replace with your desired region
#       - run:
#           name: Install Terraform
#           command: |
#             curl "https://releases.hashicorp.com/terraform/1.0.0/terraform_1.0.0_linux_amd64.zip" -o "terraform.zip"
#             unzip terraform.zip
#             sudo mv terraform /usr/local/bin/
#       - terraform/install
#       - terraform/init
#       - terraform/validate
#       - terraform/plan
#       # - run:
#       #     name: Terraform Init
#       #     command: terraform init
#       # - run:
#       #     name: Terraform Validate
#       #     command: terraform validate
#       # - run:
#       #     name: Terraform Plan
#       #     command: terraform plan

#   deploy:
#     docker:
#       - image: circleci/python:3.9
#     steps:
#       - checkout
#       - attach_workspace:
#           at: .
#       - run:
#           name: Terraform Init
#           command: terraform init
#       - run:
#           name: Terraform Apply
#           command: terraform apply -auto-approve

# # Define your workflow heree
# workflows:
#   version: 2
#   build_and_deploy:
#     jobs:
#       - build:
#           filters:
#             branches:
#               only:
#                 - feature
#       - deploy:
#           filters:
#             branches:
#               only:
#                 - main

version: 2.1

orbs:
  terraform: "circleci/terraform@1.1.0"

workflows:
  build_and_deploy:
    jobs:
      - terraform/fmt:
          context: terraform
      - terraform/validate:
          context: terraform
          requires:
            - terraform/fmt
      - terraform/plan:
          context: terraform
          persist_workspace: true
            root: .
            paths:
              - terraform.tfstate
          requires:
            - terraform/validate
      - deploy:
          context: terraform
          requires:
            - terraform/plan

jobs:
  deploy:
    docker:
      - image: circleci/python:3.9
      - image: hashicorp/terraform:1.0.0
    environment:
      TF_VAR_aws_region: "us-west-1"  # Replace with your desired region
      TF_VAR_aws_bucket_name: "my-terraform-state-bucket"  # Replace with your S3 bucket name
    steps:
      - checkout
      - run:
          name: Configure AWS credentials
          command: |
            aws configure set aws_access_key_id $var.access_key
            aws configure set aws_secret_access_key $var.secrete_key
            aws configure set default.region $var.aws_region
      - run:
          name: Terraform Init
          command: |
            terraform init -input=false -backend-config="bucket=$TF_VAR_aws_bucket_name" -backend-config="key=terraform.tfstate" -backend-config="region=$TF_VAR_aws_region"
            terraform fmt
            terraform validate
      - run:
          name: Terraform Apply
          command: |
            terraform apply -auto-approve
